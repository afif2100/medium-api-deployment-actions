name: build-and-deploy

on:
  pull_request:
    branches:
      - main
    types:
      - opened



jobs:
  build:
    # if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
    - run: |
        echo The PR was merged

    - uses: actions/checkout@v3
    - id: auth
      uses: google-github-actions/auth@v0
      with:
        credentials_json: ${{ secrets.GCLOUD_SERVICE_ACCOUNT }}

    - name: "Set up Cloud SDK"
      uses: "google-github-actions/setup-gcloud@v0"

    - uses: RafikFarhad/push-to-gcr-github-action@v5-beta
      with:
        registry: asia.gcr.io
        project_id: hvzn-development
        image_name: afif2100/fastapi-app
        image_tag: latest,${{ github.sha }}
        dockerfile: ./api/dockerfile
        context: ./api/

  deploy:
    name: deploy docker on cloud run
    needs: build
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: gcloud auth
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCLOUD_SERVICE_ACCOUNT }}

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v0"

      - id: "deploy"
        uses: "google-github-actions/deploy-cloudrun@v0"
        with:
          service: afif2100-fastapi-app
          region: asia-southeast2
          image: "asia.gcr.io/hvzn-development/afif2100/fastapi-app:${{ github.sha }}"